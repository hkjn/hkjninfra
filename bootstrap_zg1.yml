# This config is meant to be consumed by the config transpiler, which will
# generate the corresponding Ignition config. Do not pass this config directly
# to instances of Container Linux.
update:
  group:  "beta"

locksmith:
  reboot_strategy: "etcd-lock"

storage:
  files:
    - path: /opt/bin/gather_facts
      filesystem: root
      contents:
        remote:
          url: https://raw.githubusercontent.com/hkjn/junk/master/prototest/gather_facts
          verification:
            hash:
              function: sha512
              sum: adb4105abef8d0604417009ecc0b7863ddf5a91cbbe4e17a0fed0ffccd83f8eb49957f396ed7eb10c533d9ea11eae8eb76e2a1144809db2c1c59894d21b6f61c
      mode: 0755
    - path: /opt/bin/report_client
      filesystem: root
      contents:
        remote:
          url: https://github.com/hkjn/junk/releases/download/1.5.10/report_client_x86_64
          verification:
            hash:
              function: sha512
              sum: f8eae52ca28902ef2f675378143464f7e0e4847066d2b2cc3170bb758819ede4aad8a4a641be1037cb924812de88f5ef0eb6db46a69810cd3dcf0c3ced6f4f08
      mode: 0755

systemd:
  units:
    - name: bitcoin.service
      enable: true
      contents: |
        [Unit]
        Description=bitcoind
        After=network-online.target

        [Service]
        ExecStartPre=-/bin/bash -c "docker pull hkjn/bitcoin:$(uname -m)"
        ExecStartPre=-/usr/bin/docker stop bitcoin
        ExecStartPre=-/usr/bin/docker rm bitcoin
        ExecStart=/bin/bash -c " \
          docker run --name bitcoin \
                     -p 8333:8333 \
                     --memory=1050m \
                     --cpu-shares=128 \
                     -v /containers/bitcoin:/home/bitcoin/.bitcoin \
                     hkjn/bitcoin:$(uname -m)"
        Restart=always

        [Install]
        WantedBy=network-online.target

    - name: report_client.service
      enable: true
      contents: |
        [Unit]
        Description=report client
        After=network-online.target
        
        [Service]
        Environment=PATH=/usr/bin/:/opt/bin:/bin
        Environment=REPORT_ADDR=mon.hkjn.me:50051
        Environment=REPORT_NAME=%H
        Environment=REPORT_FACTS_PATH=/etc/report/facts.json
        Environment=VERSION=1.5.7
        ExecStartPre=/usr/bin/mkdir -p /etc/report
        ExecStartPre=-/bin/bash -c "gather_facts > /etc/report/facts.json"
        ExecStart=/bin/bash -c report_client

        [Install]
        WantedBy=network-online.target
 
    - name: containers.mount
      enable: true
      contents: |
        [Mount]
        What=/dev/disk/by-id/scsi-0Google_PersistentDisk_persistent-disk-1-part1
        Where=/containers
        Type=xfs

        [Install]
        RequiredBy=local-fs.target
