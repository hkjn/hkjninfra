# This config is meant to be consumed by the config transpiler, which will
# generate the corresponding Ignition config. Do not pass this config directly
# to instances of Container Linux.

update:
  group:  "alpha"

locksmith:
  reboot_strategy: "etcd-lock"

storage:
  filesystems:
    - mount:
        device: /dev/disk/by-id/scsi-0Google_PersistentDisk_persistent-disk-1
        format: ext4
        create:
  files:
    - path: /opt/bin/gather_facts
      filesystem: root
      contents:
        remote:
          url: https://github.com/hkjn/hkjninfra/releases/download/1.0.5/gather_facts
          verification:
            hash:
              function: sha512
              sum: adb4105abef8d0604417009ecc0b7863ddf5a91cbbe4e17a0fed0ffccd83f8eb49957f396ed7eb10c533d9ea11eae8eb76e2a1144809db2c1c59894d21b6f61c
      mode: 0755
    - path: /opt/bin/report_client
      filesystem: root
      contents:
        remote:
          url: https://github.com/hkjn/hkjninfra/releases/download/1.0.5/report_client_x86_64
          verification:
            hash:
              function: sha512
              sum: cb6b5c3a1ac6c56d996c4bcd6f44b76bf63f4f90e81a6fb25273f95e4ce967c38d6ad060844caab7fcbc6ca5a3ed35da1212a6a076ec54cbfdc3e5dfdf41597e
      mode: 0755
    - path: /opt/bin/decenter_world
      filesystem: root
      contents:
        remote:
          url: https://github.com/hkjn/decenter.world/releases/download/1.1.1/decenter_world_x86_64
          verification:
            hash:
              function: sha512
              sum: 720604e3d5e594076f9ff2416a9a56b3354dc5255c0b42fe8de8aeb268b39eda80380f466b4834ab8812888995d83b96ff76948a90f7022d0ec0ef3bee4a2965
      mode: 0755
    - path: /opt/bin/decenter_redirector
      filesystem: root
      contents:
        remote:
          url: https://github.com/hkjn/decenter.world/releases/download/1.1.1/decenter_redirector_x86_64
          verification:
            hash:
              function: sha512
              sum: 8026412bcc856bb073e01a5b984e0a2161049b76e575cfc506bf733a03ca70ed2fffe0a83d269a578936a545066500603b3a86c9e6a47905376108b8af41837e
      mode: 0755
systemd:
  units:
    - name: report_client.service
      enable: true
      contents: |
        [Unit]
        Description=report client
        After=network-online.target
        
        [Service]
        Environment=PATH=/usr/bin/:/opt/bin:/bin
        Environment=REPORT_ADDR=mon.hkjn.me:50051
        Environment=REPORT_NAME=%H
        Environment=REPORT_FACTS_PATH=/etc/report_facts.json
        ExecStartPre=-/bin/bash -c "gather_facts > /etc/report_facts.json"
        ExecStart=/bin/bash -c report_client

        [Install]
        WantedBy=multi-user.target
    - name: report_client.timer
      enable: true
      contents: |
        [Unit]
        Description=Timer that starts report_client.service

        [Timer]
        # Run every 5 min.
        OnCalendar=*:0/5
        Persistent=true

        [Install]
        WantedBy=multi-user.target
    - name: decenter.service
      enable: true
      contents: |
        [Unit]
        Description=decenter.world server
        After=network-online.target

        [Service]
        Environment=PATH=/usr/bin/:/opt/bin:/bin
        Environment=DECENTER_WORLD_ADDR=:443
        ExecStart=/usr/bin/bash -c "decenter_world"
        Restart=always

        [Install]
        WantedBy=multi-user.target
    - name: decenter_redirector.service
      enable: true
      contents: |
        [Unit]
         Description=decenter.world redirector server
         After=network-online.target

         [Service]
         Environment=PATH=/usr/bin/:/opt/bin:/bin
         ExecStart=/usr/bin/bash -c "decenter_redirector"
         Restart=always

         [Install]
         WantedBy=multi-user.target
    - name: etc-secrets.mount
      enable: true
      contents: |
        [Mount]
        What=/dev/disk/by-id/scsi-0Google_PersistentDisk_persistent-disk-1
        Where=/etc/secrets
        Type=ext4

        [Install]
        RequiredBy=local-fs.target
